From 5b88825de674d93cfe4d6eaa525b361caca0b1e2 Mon Sep 17 00:00:00 2001
From: Murali Paluru <leodotcloud@gmail.com>
Date: Sun, 30 Jun 2024 14:18:27 +0530
Subject: [PATCH 03/10] more changes

---
 .../charts/templates/clusterrole.yaml         |  8 +++
 .../charts/templates/clusterrolebinding.yaml  | 12 ++++
 .../charts/templates/deployment.yaml          | 60 +++++++++++++++++++
 .../templates/network_policy_allow_all.yaml   | 13 ++++
 .../templates/validate-install-crd.yaml       | 14 +++++
 5 files changed, 107 insertions(+)
 create mode 100644 packages/rancher-supportability-review/charts/templates/clusterrole.yaml
 create mode 100644 packages/rancher-supportability-review/charts/templates/clusterrolebinding.yaml
 create mode 100644 packages/rancher-supportability-review/charts/templates/deployment.yaml
 create mode 100644 packages/rancher-supportability-review/charts/templates/network_policy_allow_all.yaml
 create mode 100755 packages/rancher-supportability-review/charts/templates/validate-install-crd.yaml

diff --git a/packages/rancher-supportability-review/charts/templates/clusterrole.yaml b/packages/rancher-supportability-review/charts/templates/clusterrole.yaml
new file mode 100644
index 000000000..9fda2aea2
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/clusterrole.yaml
@@ -0,0 +1,8 @@
+apiVersion: rbac.authorization.k8s.io/v1
+kind: ClusterRole
+metadata:
+  name: {{ include "rancher-supportability-review.fullname" . }}-cr
+rules:
+- apiGroups: ["*"]
+  resources: ["*"]
+  verbs: ["*"]
diff --git a/packages/rancher-supportability-review/charts/templates/clusterrolebinding.yaml b/packages/rancher-supportability-review/charts/templates/clusterrolebinding.yaml
new file mode 100644
index 000000000..e329c7ece
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/clusterrolebinding.yaml
@@ -0,0 +1,12 @@
+apiVersion: rbac.authorization.k8s.io/v1
+kind: ClusterRoleBinding
+metadata:
+  name: {{ include "rancher-supportability-review.fullname" . }}-crb
+roleRef:
+  apiGroup: rbac.authorization.k8s.io
+  kind: ClusterRole
+  name: {{ include "rancher-supportability-review.fullname" . }}-cr
+subjects:
+- kind: ServiceAccount
+  name: {{ include "rancher-supportability-review.serviceAccountName" . }}
+  namespace: {{ .Release.Namespace }}
diff --git a/packages/rancher-supportability-review/charts/templates/deployment.yaml b/packages/rancher-supportability-review/charts/templates/deployment.yaml
new file mode 100644
index 000000000..f54f674bb
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/deployment.yaml
@@ -0,0 +1,60 @@
+apiVersion: apps/v1
+kind: Deployment
+metadata:
+  name: {{ include "rancher-supportability-review.fullname" . }}
+  labels:
+    {{- include "rancher-supportability-review.labels" . | nindent 4 }}
+spec:
+  {{- if not .Values.autoscaling.enabled }}
+  replicas: {{ .Values.replicaCount }}
+  {{- end }}
+  selector:
+    matchLabels:
+      {{- include "rancher-supportability-review.selectorLabels" . | nindent 6 }}
+  template:
+    metadata:
+      {{- with .Values.podAnnotations }}
+      annotations:
+        {{- toYaml . | nindent 8 }}
+      {{- end }}
+      labels:
+        {{- include "rancher-supportability-review.labels" . | nindent 8 }}
+        {{- with .Values.podLabels }}
+        {{- toYaml . | nindent 8 }}
+        {{- end }}
+    spec:
+      {{- with .Values.imagePullSecrets }}
+      imagePullSecrets:
+        {{- toYaml . | nindent 8 }}
+      {{- end }}
+      serviceAccountName: {{ include "rancher-supportability-review.serviceAccountName" . }}
+      securityContext:
+        {{- toYaml .Values.podSecurityContext | nindent 8 }}
+      containers:
+        - name: {{ .Chart.Name }}
+          securityContext:
+            {{- toYaml .Values.securityContext | nindent 12 }}
+          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
+          imagePullPolicy: {{ .Values.image.pullPolicy }}
+          resources:
+            {{- toYaml .Values.resources | nindent 12 }}
+          {{- with .Values.volumeMounts }}
+          volumeMounts:
+            {{- toYaml . | nindent 12 }}
+          {{- end }}
+      {{- with .Values.volumes }}
+      volumes:
+        {{- toYaml . | nindent 8 }}
+      {{- end }}
+      {{- with .Values.nodeSelector }}
+      nodeSelector:
+        {{- toYaml . | nindent 8 }}
+      {{- end }}
+      {{- with .Values.affinity }}
+      affinity:
+        {{- toYaml . | nindent 8 }}
+      {{- end }}
+      {{- with .Values.tolerations }}
+      tolerations:
+        {{- toYaml . | nindent 8 }}
+      {{- end }}
diff --git a/packages/rancher-supportability-review/charts/templates/network_policy_allow_all.yaml b/packages/rancher-supportability-review/charts/templates/network_policy_allow_all.yaml
new file mode 100644
index 000000000..926ceea6d
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/network_policy_allow_all.yaml
@@ -0,0 +1,13 @@
+apiVersion: networking.k8s.io/v1
+kind: NetworkPolicy
+metadata:
+  name: default-allow-all
+spec:
+  podSelector: {}
+  ingress:
+  - {}
+  egress:
+  - {}
+  policyTypes:
+  - Ingress
+  - Egress
diff --git a/packages/rancher-supportability-review/charts/templates/validate-install-crd.yaml b/packages/rancher-supportability-review/charts/templates/validate-install-crd.yaml
new file mode 100755
index 000000000..ab7d90631
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/validate-install-crd.yaml
@@ -0,0 +1,14 @@
+#{{- if gt (len (lookup "rbac.authorization.k8s.io/v1" "ClusterRole" "" "")) 0 -}}
+# {{- $found := dict -}}
+# {{- set $found "sr.cattle.io/v1/ReviewBundle" false -}}
+# {{- range .Capabilities.APIVersions -}}
+# {{- if hasKey $found (toString .) -}}
+# 	{{- set $found (toString .) true -}}
+# {{- end -}}
+# {{- end -}}
+# {{- range $_, $exists := $found -}}
+# {{- if (eq $exists false) -}}
+# 	{{- required "Required CRDs are missing. Please install the corresponding CRD chart before installing this chart." "" -}}
+# {{- end -}}
+# {{- end -}}
+#{{- end -}}
\ No newline at end of file
-- 
2.25.1

