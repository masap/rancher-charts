From 9f79d80eff3887fe7ab5068d31cbbec24be0848f Mon Sep 17 00:00:00 2001
From: Murali Paluru <leodotcloud@gmail.com>
Date: Sun, 30 Jun 2024 13:50:00 +0530
Subject: [PATCH 01/10] add sr package

---
 .../charts/Chart.yaml                         | 22 +++++
 .../charts/README.md                          |  9 ++
 .../charts/app-readme.md                      |  3 +
 .../charts/crds/reviewbundle.yaml             | 81 +++++++++++++++++
 .../charts/templates/_helpers.tpl             | 90 +++++++++++++++++++
 .../charts/templates/secret.yaml              |  9 ++
 .../charts/templates/serviceaccount.yaml      | 13 +++
 .../charts/values.yaml                        | 83 +++++++++++++++++
 .../package.yaml                              |  8 ++
 .../templates/crd-template/Chart.yaml         | 10 +++
 .../templates/crd-template/README.md          |  2 +
 11 files changed, 330 insertions(+)
 create mode 100644 packages/rancher-supportability-review/charts/Chart.yaml
 create mode 100644 packages/rancher-supportability-review/charts/README.md
 create mode 100644 packages/rancher-supportability-review/charts/app-readme.md
 create mode 100755 packages/rancher-supportability-review/charts/crds/reviewbundle.yaml
 create mode 100644 packages/rancher-supportability-review/charts/templates/_helpers.tpl
 create mode 100644 packages/rancher-supportability-review/charts/templates/secret.yaml
 create mode 100644 packages/rancher-supportability-review/charts/templates/serviceaccount.yaml
 create mode 100644 packages/rancher-supportability-review/charts/values.yaml
 create mode 100644 packages/rancher-supportability-review/package.yaml
 create mode 100644 packages/rancher-supportability-review/templates/crd-template/Chart.yaml
 create mode 100644 packages/rancher-supportability-review/templates/crd-template/README.md

diff --git a/packages/rancher-supportability-review/charts/Chart.yaml b/packages/rancher-supportability-review/charts/Chart.yaml
new file mode 100644
index 000000000..3c6af373f
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/Chart.yaml
@@ -0,0 +1,22 @@
+annotations:
+  catalog.cattle.io/auto-install: rancher-supportability-review-crd=match
+  catalog.cattle.io/certified: rancher
+  catalog.cattle.io/display-name: Supportability Review
+  catalog.cattle.io/kube-version: '>= 1.20.0-0 < 1.31.0-0'
+  catalog.cattle.io/namespace: sr-operator-system
+  catalog.cattle.io/os: linux
+  catalog.cattle.io/permits-os: linux,windows
+  catalog.cattle.io/provides-gvr: sr.cattle.io.reviewbundles/v1
+  catalog.cattle.io/rancher-version: '>= 2.6.0-0 < 2.10.0-0'
+  catalog.cattle.io/release-name: rancher-supportability-review
+  catalog.cattle.io/type: cluster-tool
+  catalog.cattle.io/ui-component: rancher-supportability-review
+apiVersion: v1
+appVersion: v1.0.0
+description: The rancher-supportability-review operator enables the functionality
+  of Supportability Reviews for Rancher.
+icon: https://charts.rancher.io/assets/logos/cis-kube-bench.svg
+keywords:
+- support
+name: rancher-supportability-review
+version: 1.0.0
diff --git a/packages/rancher-supportability-review/charts/README.md b/packages/rancher-supportability-review/charts/README.md
new file mode 100644
index 000000000..f23e157e6
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/README.md
@@ -0,0 +1,9 @@
+# Rancher Supportability Review Chart
+
+The supportability-review-operator enables running Supportability Reviews.
+
+# Installation
+
+```
+helm install rancher-supportability-review ./ --create-namespace -n sr-operator-system
+```
diff --git a/packages/rancher-supportability-review/charts/app-readme.md b/packages/rancher-supportability-review/charts/app-readme.md
new file mode 100644
index 000000000..d25a2fd1f
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/app-readme.md
@@ -0,0 +1,3 @@
+# Rancher Supportability Review
+
+This chart is used for Supportability Review of Rancher.
diff --git a/packages/rancher-supportability-review/charts/crds/reviewbundle.yaml b/packages/rancher-supportability-review/charts/crds/reviewbundle.yaml
new file mode 100755
index 000000000..c1dcf9df7
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/crds/reviewbundle.yaml
@@ -0,0 +1,81 @@
+apiVersion: apiextensions.k8s.io/v1
+kind: CustomResourceDefinition
+metadata:
+  name: reviewbundles.sr.cattle.io
+spec:
+  group: sr.cattle.io
+  names:
+    kind: ReviewBundle
+    plural: reviewbundles
+    singular: reviewbundle
+  scope: Cluster
+  versions:
+  - additionalPrinterColumns:
+    - jsonPath: .status.timestamp
+      name: Timestamp
+      type: string
+    name: v1
+    schema:
+      openAPIV3Schema:
+        properties:
+          spec:
+            properties:
+              debug:
+                type: boolean
+              dev:
+                type: boolean
+              excludeClusters:
+                items:
+                  nullable: true
+                  type: string
+                nullable: true
+                type: array
+              includeClusters:
+                items:
+                  nullable: true
+                  type: string
+                nullable: true
+                type: array
+              parallelCollection:
+                type: boolean
+              sonobuoyNamespace:
+                nullable: true
+                type: string
+              sonobuoyTimeout:
+                type: integer
+            type: object
+          status:
+            properties:
+              conditions:
+                items:
+                  properties:
+                    lastTransitionTime:
+                      nullable: true
+                      type: string
+                    lastUpdateTime:
+                      nullable: true
+                      type: string
+                    message:
+                      nullable: true
+                      type: string
+                    reason:
+                      nullable: true
+                      type: string
+                    status:
+                      nullable: true
+                      type: string
+                    type:
+                      nullable: true
+                      type: string
+                  type: object
+                nullable: true
+                type: array
+              timestamp:
+                nullable: true
+                type: string
+            type: object
+        type: object
+    served: true
+    storage: true
+    subresources:
+      status: {}
diff --git a/packages/rancher-supportability-review/charts/templates/_helpers.tpl b/packages/rancher-supportability-review/charts/templates/_helpers.tpl
new file mode 100644
index 000000000..2ac000849
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/_helpers.tpl
@@ -0,0 +1,90 @@
+{{/*
+Expand the name of the chart.
+*/}}
+{{- define "rancher-supportability-review.name" -}}
+{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
+{{- end }}
+
+{{/*
+Create a default fully qualified app name.
+We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
+If release name contains chart name it will be used as a full name.
+*/}}
+{{- define "rancher-supportability-review.fullname" -}}
+{{- if .Values.fullnameOverride }}
+{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
+{{- else }}
+{{- $name := default .Chart.Name .Values.nameOverride }}
+{{- if contains $name .Release.Name }}
+{{- .Release.Name | trunc 63 | trimSuffix "-" }}
+{{- else }}
+{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
+{{- end }}
+{{- end }}
+{{- end }}
+
+{{/*
+Create chart name and version as used by the chart label.
+*/}}
+{{- define "rancher-supportability-review.chart" -}}
+{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
+{{- end }}
+
+{{/*
+Common labels
+*/}}
+{{- define "rancher-supportability-review.labels" -}}
+helm.sh/chart: {{ include "rancher-supportability-review.chart" . }}
+{{ include "rancher-supportability-review.selectorLabels" . }}
+{{- if .Chart.AppVersion }}
+app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
+{{- end }}
+app.kubernetes.io/managed-by: {{ .Release.Service }}
+{{- end }}
+
+{{/*
+Selector labels
+*/}}
+{{- define "rancher-supportability-review.selectorLabels" -}}
+app.kubernetes.io/name: {{ include "rancher-supportability-review.name" . }}
+app.kubernetes.io/instance: {{ .Release.Name }}
+{{- end }}
+
+{{/*
+Create the name of the service account to use
+*/}}
+{{- define "rancher-supportability-review.serviceAccountName" -}}
+{{- if .Values.serviceAccount.create }}
+{{- default (include "rancher-supportability-review.fullname" .) .Values.serviceAccount.name }}
+{{- else }}
+{{- default "default" .Values.serviceAccount.name }}
+{{- end }}
+{{- end }}
+
+{{/* Ensure namespace is set the same everywhere */}}
+{{- define "sr.namespace" -}}
+  {{- .Release.Namespace | default "sr-operator-system" -}}
+{{- end -}}
+
+{{- define "system_default_registry" -}}
+{{- if .Values.global.cattle.systemDefaultRegistry -}}
+{{- printf "%s/" .Values.global.cattle.systemDefaultRegistry -}}
+{{- else -}}
+{{- "" -}}
+{{- end -}}
+{{- end -}}
+
+{{/*
+Windows cluster will add default taint for linux nodes,
+add below linux tolerations to workloads could be scheduled to those linux nodes
+*/}}
+{{- define "linux-node-tolerations" -}}
+- key: "cattle.io/os"
+  value: "linux"
+  effect: "NoSchedule"
+  operator: "Equal"
+{{- end -}}
+
+{{- define "linux-node-selector" -}}
+kubernetes.io/os: linux
+{{- end -}}
diff --git a/packages/rancher-supportability-review/charts/templates/secret.yaml b/packages/rancher-supportability-review/charts/templates/secret.yaml
new file mode 100644
index 000000000..0103975a2
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/secret.yaml
@@ -0,0 +1,9 @@
+apiVersion: v1
+kind: Secret
+metadata:
+  name: {{ .Values.secretName }}
+  namespace: {{ .Release.Namespace }}
+type: Opaque
+data:
+  url: {{ .Values.rancherUrl | b64enc }}
+  token: {{ .Values.rancherToken | b64enc }}
diff --git a/packages/rancher-supportability-review/charts/templates/serviceaccount.yaml b/packages/rancher-supportability-review/charts/templates/serviceaccount.yaml
new file mode 100644
index 000000000..64e565e5a
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/templates/serviceaccount.yaml
@@ -0,0 +1,13 @@
+{{- if .Values.serviceAccount.create -}}
+apiVersion: v1
+kind: ServiceAccount
+metadata:
+  name: {{ include "rancher-supportability-review.serviceAccountName" . }}
+  labels:
+    {{- include "rancher-supportability-review.labels" . | nindent 4 }}
+  {{- with .Values.serviceAccount.annotations }}
+  annotations:
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
+automountServiceAccountToken: {{ .Values.serviceAccount.automount }}
+{{- end }}
diff --git a/packages/rancher-supportability-review/charts/values.yaml b/packages/rancher-supportability-review/charts/values.yaml
new file mode 100644
index 000000000..76c00d3d9
--- /dev/null
+++ b/packages/rancher-supportability-review/charts/values.yaml
@@ -0,0 +1,83 @@
+# Default values for rancher-supportability-review.
+# This is a YAML-formatted file.
+# Declare variables to be passed into your templates.
+
+replicaCount: 1
+
+secretName: "sr-api-details"
+rancherUrl: ""
+rancherToken: ""
+
+image:
+  repository: ghcr.io/rancher/supportability-review-operator
+  #pullPolicy: IfNotPresent
+  pullPolicy: Always
+  # Overrides the image tag whose default is the chart appVersion.
+  tag: "latest"
+
+imagePullSecrets: []
+nameOverride: ""
+fullnameOverride: ""
+
+serviceAccount:
+  # Specifies whether a service account should be created
+  create: true
+  # Automatically mount a ServiceAccount's API credentials?
+  automount: true
+  # Annotations to add to the service account
+  annotations: {}
+  # The name of the service account to use.
+  # If not set and create is true, a name is generated using the fullname template
+  name: ""
+
+podAnnotations: {}
+podLabels: {}
+
+podSecurityContext: {}
+  # fsGroup: 2000
+
+securityContext: {}
+  # capabilities:
+  #   drop:
+  #   - ALL
+  # readOnlyRootFilesystem: true
+  # runAsNonRoot: true
+  # runAsUser: 1000
+
+resources: {}
+  # We usually recommend not to specify default resources and to leave this as a conscious
+  # choice for the user. This also increases chances charts run on environments with little
+  # resources, such as Minikube. If you do want to specify resources, uncomment the following
+  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
+  # limits:
+  #   cpu: 100m
+  #   memory: 128Mi
+  # requests:
+  #   cpu: 100m
+  #   memory: 128Mi
+
+autoscaling:
+  enabled: false
+  minReplicas: 1
+  maxReplicas: 100
+  targetCPUUtilizationPercentage: 80
+  # targetMemoryUtilizationPercentage: 80
+
+# Additional volumes on the output Deployment definition.
+volumes: []
+# - name: foo
+#   secret:
+#     secretName: mysecret
+#     optional: false
+
+# Additional volumeMounts on the output Deployment definition.
+volumeMounts: []
+# - name: foo
+#   mountPath: "/etc/foo"
+#   readOnly: true
+
+nodeSelector: {}
+
+tolerations: []
+
+affinity: {}
diff --git a/packages/rancher-supportability-review/package.yaml b/packages/rancher-supportability-review/package.yaml
new file mode 100644
index 000000000..737289577
--- /dev/null
+++ b/packages/rancher-supportability-review/package.yaml
@@ -0,0 +1,8 @@
+url: local
+version: 1.0.0
+additionalCharts:
+  - workingDir: charts-crd
+    crdOptions:
+      templateDirectory: crd-template
+      crdDirectory: templates
+      addCRDValidationToMainChart: true
diff --git a/packages/rancher-supportability-review/templates/crd-template/Chart.yaml b/packages/rancher-supportability-review/templates/crd-template/Chart.yaml
new file mode 100644
index 000000000..1883b2fea
--- /dev/null
+++ b/packages/rancher-supportability-review/templates/crd-template/Chart.yaml
@@ -0,0 +1,10 @@
+apiVersion: v1
+version: 1.0.0
+description: Installs the CRDs for rancher-supportability-review.
+name: rancher-supportability-review-crd
+type: application
+annotations:
+  catalog.cattle.io/hidden: "true"
+  catalog.cattle.io/release-name: rancher-supportability-review-crd
+  catalog.cattle.io/certified: rancher
+  catalog.cattle.io/namespace: sr-operator-system
diff --git a/packages/rancher-supportability-review/templates/crd-template/README.md b/packages/rancher-supportability-review/templates/crd-template/README.md
new file mode 100644
index 000000000..75a817d3b
--- /dev/null
+++ b/packages/rancher-supportability-review/templates/crd-template/README.md
@@ -0,0 +1,2 @@
+# rancher-supportability-review-crd
+A Rancher chart that installs the CRDs used by rancher-supportability-review.
-- 
2.25.1

